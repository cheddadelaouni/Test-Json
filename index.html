<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Neptune — Sauvegarde centrale (JSONBlob uniquement)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;max-width:980px;margin:0 auto}
  .card-h{font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .small{font-size:12px;color:#555}.ok{color:#0a7d00}.err{color:#b00020}.muted{color:#777}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  input[type=text]{flex:1;min-width:340px;padding:8px}
  button{padding:8px 12px;font-size:14px}
  .ghost{background:#f7f7f7;border:1px solid #ddd}
  code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  .log{white-space:pre-wrap;margin-top:6px}
</style>
</head>
<body>
  <h1>Neptune — Sauvegarde centrale (JSONBlob)</h1>

  <div class="card">
    <div class="card-h">
      <div>URI centrale : <code id="uriView" class="muted">(aucune)</code></div>
      <div class="small">Ouvrez en <b>https</b> (GitHub Pages). Pas en <code>file://</code>.</div>
    </div>

    <div class="row">
      <input id="uri" type="text" placeholder="Ex: https://jsonblob.com/api/json/1234567890">
      <button id="btnUseUri" class="ghost small" type="button">Utiliser cette URI</button>
    </div>

    <div class="controls">
      <button id="btnCreate" class="ghost small" type="button">Créer central (JSONBlob)</button>
      <button id="btnCopyUri" class="ghost small" type="button">Copier l’URI</button>
      <button id="btnCopyShare" class="ghost small" type="button">Copier le lien partage (?central=…)</button>
    </div>

    <hr style="margin:12px 0">

    <div class="controls">
      <button id="btnPull" class="ghost" type="button">← Charger</button>
      <button id="btnPush" type="button">Enregistrer →</button>
      <button id="btnTest" class="ghost small" type="button">Tester accès</button>
    </div>

    <div id="status" class="small muted log">—</div>
    <div id="lastErr" class="small err log" style="display:none"></div>
  </div>

<script>
(function(){"use strict";
  const $ = (s)=>document.querySelector(s);
  const status = (m, cls="")=>{ const el=$("#status"); el.textContent = m + " ("+new Date().toLocaleTimeString()+")"; el.className = "small log " + (cls||"muted"); console.log("[central]", m); }
  const showErr = (e)=>{ const el=$("#lastErr"); el.style.display="block"; el.textContent = e; }
  const clrErr  = ()=>{ const el=$("#lastErr"); el.style.display="none"; el.textContent=""; }

  const JB_RE = /^https:\/\/jsonblob\.com\/api\/json\/[0-9A-Za-z-_.]+(?:\/.*)?$/;

  function getUri(){ return ($("#uri").value||"").trim(); }
  function setUri(u){ $("#uri").value = u||""; showUri(); }
  function showUri(){ $("#uriView").textContent = getUri() || "(aucune)"; }

  function ensureAppData(){
    if(typeof window.save==="function"){ try{ window.save(); }catch(e){} }
    if(!window.data || typeof window.data!=="object") window.data = {};
    if(!window.data.__meta) window.data.__meta = {};
    window.data.__meta.updatedAt = new Date().toISOString();
    return window.data;
  }

  // Empêche d'utiliser JsonStorage par erreur
  function assertJsonBlob(u){
    if(!JB_RE.test(u)){
      throw new Error("URI non valide JSONBlob (doit commencer par https://jsonblob.com/api/json/...)");
    }
  }

  async function createCentral(){
    clrErr();
    try{
      status("Création (JSONBlob)…");
      const r = await fetch("https://jsonblob.com/api/json", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({})
      });
      const loc = r.headers.get("Location");
      const t = await r.text();
      if(!r.ok) throw new Error("POST "+r.status+" — "+t.slice(0,200));
      if(!loc) throw new Error("Pas d’en-tête Location");
      setUri(loc);
      status("Central créé (JSONBlob). Clique Enregistrer →", "ok");
    }catch(e){ status("Échec création — "+(e.message||e), "err"); }
  }

  async function testAccess(){
    clrErr();
    const u = getUri(); if(!u) return status("Renseigne l’URI d’abord", "err");
    try{
      assertJsonBlob(u);
      status("Test accès…");
      const r = await fetch(u, {method:"GET", cache:"no-cache"});
      const t = await r.text();
      status("Test "+r.status+(r.ok?" OK":" — "+t.slice(0,120)), r.ok?"ok":"err");
    }catch(e){ status("Test — "+(e.message||e), "err"); }
  }

  async function pullNow(){
    clrErr();
    const u = getUri(); if(!u) return status("Renseigne l’URI d’abord", "err");
    try{
      assertJsonBlob(u);
      status("Lecture…");
      const r = await fetch(u, {method:"GET", cache:"no-cache"});
      if(!r.ok){ const t=await r.text(); throw new Error("GET "+r.status+" — "+t.slice(0,200)); }
      window.data = await r.json();
      try{ if(typeof window.refreshActivePage==="function") window.refreshActivePage(); }catch(_){}
      status("Chargé", "ok");
    }catch(e){ status("Échec lecture — "+(e.message||e), "err"); }
  }

  async function pushNow(){
    clrErr();
    if(location.protocol==="file:") return status("Ouvrez en https (GitHub Pages)", "err");
    const u = getUri(); if(!u) return status("Renseigne l’URI d’abord", "err");
    try{
      assertJsonBlob(u);
      status("Préparation…");
      const d = ensureAppData();
      const body = JSON.stringify(d);
      status("Écriture (JSONBlob)…");
      const r = await fetch(u, {method:"PUT", headers:{"Content-Type":"application/json"}, body});
      const t = await r.text();
      if(!r.ok) throw new Error("PUT "+r.status+" — "+t.slice(0,200));
      status("Enregistré ✅ — HTTP "+r.status, "ok");
    }catch(e){ status("Échec écriture — "+(e.message||e), "err"); }
  }

  // Partage : lien avec ?central=...
  function copyUri(){ try{ navigator.clipboard.writeText(getUri()); status("URI copiée", "ok"); }catch(e){ status("Copie impossible — "+(e.message||e),"err"); } }
  function copyShare(){
    const u = getUri(); if(!u) return status("Renseigne l’URI d’abord", "err");
    try{
      assertJsonBlob(u);
      const share = location.origin + location.pathname + "?central=" + encodeURIComponent(u);
      navigator.clipboard.writeText(share);
      status("Lien de partage copié (ouvre-le sur un autre PC)", "ok");
    }catch(e){ status("Copie impossible — "+(e.message||e), "err"); }
  }
  function useUri(){ setUri(getUri()); status("URI définie — prêt", "ok"); }

  // Init depuis ?central=...
  (function initFromQuery(){
    try{
      const p = new URLSearchParams(location.search);
      const central = p.get("central");
      if(central){ setUri(central); status("URI chargée depuis l’URL — prêt", "ok"); }
    }catch(e){}
  })();

  // Bind UI
  $("#btnCreate").onclick   = createCentral;
  $("#btnCopyUri").onclick  = copyUri;
  $("#btnCopyShare").onclick= copyShare;
  $("#btnUseUri").onclick   = useUri;
  $("#btnTest").onclick     = testAccess;
  $("#btnPull").onclick     = pullNow;
  $("#btnPush").onclick     = pushNow;
})();
</script>
</body>
</html>
