<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Neptune — Sauvegarde centrale (JsonStorage / URI longue)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#f8fafc;--card:#ffffff;--muted:#667085;--ok:#0a7d00;--err:#b00020;
    --border:#e5e7eb;--accent:#1a7f37;--shadow:0 2px 10px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font:14px system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  .card h2{margin:0 0 10px;font-size:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  button{padding:8px 12px;font-size:14px;border-radius:10px;border:1px solid var(--border);background:#f7f7f7;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  code.kv{background:#f6f6f6;border-radius:6px;padding:2px 6px}
  textarea{width:100%;height:340px;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:13px;line-height:1.4}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:12px;color:var(--muted)}
  .foot{margin-top:8px}
  .bar{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:8px 10px;z-index:9999}
</style>
</head>
<body>
<div class="wrap">
  <h1>Neptune — Sauvegarde centrale (JsonStorage / URI longue)</h1>

  <div class="grid">
    <div class="card">
      <h2>Éditeur de données (JSON)</h2>
      <div class="row muted">Ces données correspondent à <code class="kv">window.data</code>. Elles sont enregistrées sur le JSON central.</div>
      <textarea id="editor" spellcheck="false" placeholder='{ "exemple": true }'></textarea>
      <div class="row">
        <button id="btnFromData">↺ Recharger depuis window.data</button>
        <button id="btnToData" class="primary">⮕ Appliquer au document</button>
      </div>
      <div id="editStatus" class="muted">—</div>
    </div>

    <div class="card">
      <h2>Sauvegarde JSON central</h2>
      <div class="row">
        <span class="badge">Clé intégrée</span>
        <span class="badge">URI longue</span>
      </div>
      <div class="row muted" style="word-break:break-all">
        URI: <code class="kv">https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/caa3fc75-d869-4cc7-99fa-7fa93b38145c</code>
      </div>
      <div class="row">
        <button id="btnPull" title="Lire le JSON central">← Charger</button>
        <button id="btnPush" class="primary" title="Écrire sur le JSON central">Enregistrer →</button>
        <button id="btnTest">Tester GET</button>
      </div>
      <div id="status" class="muted">—</div>
      <div id="err" class="err" style="display:none"></div>
      <div class="foot muted">Lecture/Écriture effectuées sur l’<b>URI longue</b> + <code class="kv">?apiKey=…</code>.</div>
    </div>
  </div>
</div>

<!-- Barre flottante minimaliste -->
<div class="bar">
  <button id="barLoad">← Charger</button>
  <button id="barSave" class="primary">Enregistrer →</button>
  <span id="barStatus" class="muted">—</span>
</div>

<script>
(function(){"use strict";
  // === Config figée (validée) ===
  const API_KEY  = '1c5f1698-c8f7-4992-988a-d1ae29cb35ee';
  const LONG_URI = 'https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/caa3fc75-d869-4cc7-99fa-7fa93b38145c';

  // === Utils ===
  const $ = (s)=>document.querySelector(s);
  const at = ()=> new Date().toLocaleTimeString();
  const withKey = (u)=> u + (u.includes("?")?"&":"?") + "apiKey=" + encodeURIComponent(API_KEY);
  const setTxt = (id, txt, cls) => { const el=$(id); if(!el) return; el.textContent = txt + " ("+at()+")"; if(cls) el.className = cls; };
  const showErr = (msg)=>{ const el=$("#err"); el.style.display="block"; el.textContent = msg; };
  const hideErr = ()=>{ const el=$("#err"); el.style.display="none"; el.textContent=""; };

  function ensureData(){
    try{ if(typeof window.save==="function") window.save(); }catch(_ ){}
    if(!window.data || typeof window.data!=="object") window.data = {"notes":"", "items":[]};
    if(!window.data.__meta) window.data.__meta = {};
    window.data.__meta.updatedAt = new Date().toISOString();
    return window.data;
  }

  async function centralGET(){
    const r = await fetch(withKey(LONG_URI), { method:"GET", cache:"no-cache" });
    const t = await r.text();
    if(!r.ok) throw new Error("GET "+r.status+" — "+t.slice(0,200));
    return JSON.parse(t || "{}");
  }

  async function centralPUT(obj){
    const body = JSON.stringify(obj);
    const r = await fetch(withKey(LONG_URI), {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body,
      cache:"no-store"
    });
    const t = await r.text();
    if(!r.ok) throw new Error("PUT "+r.status+" — "+t.slice(0,200));
    return true;
  }

  function applyState(remote){
    if(remote && typeof remote==="object"){
      window.data = remote;
      try{ if(typeof window.refreshActivePage==="function") window.refreshActivePage(); }catch(_ ){}
      try{ if(typeof window.render==="function") window.render(); }catch(_ ){}
      // maj éditeur
      try{ $("#editor").value = JSON.stringify(window.data, null, 2); setTxt("#editStatus","Éditeur mis à jour","muted"); }catch(_ ){}
    }
  }

  // === Actions ===
  async function actionPull(){
    hideErr();
    try{ setTxt("#status","Lecture…","muted"); $("#barStatus").textContent="Lecture…"; const j = await centralGET(); applyState(j); setTxt("#status","Chargé","ok"); $("#barStatus").textContent="Chargé"; }
    catch(e){ setTxt("#status","Échec lecture — "+(e.message||e),"err"); $("#barStatus").textContent="Échec lecture"; showErr(String(e.message||e)); }
  }

  async function actionPush(){
    hideErr();
    if(location.protocol==="file:") return setTxt("#status","Ouvrez en HTTPS (GitHub Pages)","err");
    try{ setTxt("#status","Préparation…","muted"); $("#barStatus").textContent="Préparation…"; const d = ensureData(); setTxt("#status","Écriture…","muted"); $("#barStatus").textContent="Écriture…"; await centralPUT(d); setTxt("#status","Enregistré ✅","ok"); $("#barStatus").textContent="Enregistré ✅"; }
    catch(e){ setTxt("#status","Échec écriture — "+(e.message||e),"err"); $("#barStatus").textContent="Échec écriture"; showErr(String(e.message||e)); }
  }

  // === Éditeur JSON (optionnel mais pratique) ===
  $("#btnFromData").onclick = ()=>{ try{ $("#editor").value = JSON.stringify(ensureData(), null, 2); setTxt("#editStatus","Rechargé depuis window.data","muted"); }catch(e){ setTxt("#editStatus","Erreur rechargement — "+e,"err"); } };
  $("#btnToData").onclick   = ()=>{ try{ const j = JSON.parse($("#editor").value||"{}"); window.data = j; setTxt("#editStatus","Appliqué à window.data","ok"); }catch(e){ setTxt("#editStatus","JSON invalide — "+e,"err"); } };

  // === Bind UI ===
  $("#btnPull").onclick = actionPull;
  $("#btnPush").onclick = actionPush;
  $("#btnTest").onclick = async ()=>{ hideErr(); try{ const r = await fetch(withKey(LONG_URI),{method:"GET",cache:"no-cache"}); const t = await r.text(); setTxt("#status","Test "+r.status+(r.ok?" OK":" — "+t.slice(0,80)), r.ok?"ok":"err"); }catch(e){ setTxt("#status","Test — "+(e.message||e),"err"); } };
  $("#barLoad").onclick = actionPull;
  $("#barSave").onclick = actionPush;

  // === Charge automatiquement au démarrage ===
  document.addEventListener("DOMContentLoaded", async ()=>{
    try{ const j = await centralGET(); applyState(j); setTxt("#status","Prêt (donnée distante chargée)","ok"); $("#barStatus").textContent="Prêt"; }
    catch(_ ){ setTxt("#status","Prêt (pas de donnée distante)","muted"); $("#barStatus").textContent="Prêt"; }
    // Si vide, initialise l'éditeur
    if(!$("#editor").value.trim()) { $("#editor").value = JSON.stringify(ensureData(), null, 2); }
  });
})();
</script>
</body>
</html>
